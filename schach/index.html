<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Chess Clock</title>
  <meta name="viewport"
        content="width=device-width,initial-scale=1.0,maximum-scale=1,user-scalable=no" />

  <style>
    :root {
      --beige: #fee7b6;
      --green: #2ecc71;
      --gray:  #b4b4b4;
      --gray-light: #efefef;
      --black: #000;
      --white: #fff;
      --shadow: 0 4px 10px rgba(0,0,0,.25);
    }

    /* --- reset & basics --- */
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; width: 100%; background: var(--beige); font-family: "Segoe UI", sans-serif; overscroll-behavior: none; }

    /* --- page layout --- */
    #wrapper   { height: 100%; display: flex; flex-direction: column; gap: 0.75rem; padding: 0.75rem; }

    /* --- timer buttons --- */
    .timer {
      flex: 1;
      border: none;
      border-radius: 14px;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s, color 0.2s;
      font-variant-numeric: tabular-nums;
      color: var(--white);
      background: var(--gray);
    }
    .timer.active   { background: var(--green); }
    .timer.paused   { background: var(--gray-light); }

    .time {
      font-size: 18vw;
      line-height: 1;
    }
    @media (min-aspect-ratio: 3/2) { .time { font-size: 18vh; } }

    /* --- central controls --- */
    #controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
    }
    button.ctrl {
      padding: 0.6rem 1rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      color: var(--white);
      background: var(--black);
      box-shadow: var(--shadow);
    }
    select#preset {
      padding: 0.6rem 0.8rem;
      border-radius: 8px;
      border: none;
      font-size: 1rem;
      background: var(--gray);
      color: var(--white);
      cursor: pointer;
      box-shadow: var(--shadow);
    }

    /* --- settings drawer --- */
    #settingsBtn {
      position: fixed; top: 0.4rem; right: 0.4rem;
      background: transparent; border: none; font-size: 2rem; cursor: pointer;
    }
    #settingsPanel {
      position: fixed; top: 0; right: -260px;
      width: 260px; height: 100%; padding: 1rem;
      display: flex; flex-direction: column; gap: 1rem;
      background: var(--beige); box-shadow: -3px 0 8px rgba(0,0,0,.25);
      transition: right 0.3s ease; z-index: 15;
    }
    #settingsPanel.open { right: 0; }
    .switch { position: relative; width: 46px; height: 24px; display: inline-block; }
    .switch input{opacity:0;width:0;height:0;}
    .slider{position:absolute;top:0;left:0;right:0;bottom:0;background:var(--gray);border-radius:34px;transition:.2s;}
    .slider:before{content:"";position:absolute;left:3px;bottom:3px;width:18px;height:18px;border-radius:50%;background:var(--white);transition:.2s;}
    input:checked+.slider{background:var(--black);}
    input:checked+.slider:before{transform:translateX(22px);}
    h2{font-size:1.3rem;margin-bottom:.3rem;}
    label{display:flex;align-items:center;gap:.5rem;font-size:1rem;color:var(--black);}
  </style>
</head>

<body>
  <button id="settingsBtn" aria-label="Settings">⚙️</button>

  <div id="wrapper">
    <button id="p1" class="timer"><span id="t1" class="time">05:00</span></button>

    <div id="controls">
      <button id="pauseBtn" class="ctrl">Pause</button>
      <button id="resetBtn" class="ctrl">Reset</button>
      <select id="preset" aria-label="Preset time">
        <option value="300">5 min</option>
        <option value="600">10 min</option>
        <option value="900">15 min</option>
      </select>
    </div>

    <button id="p2" class="timer"><span id="t2" class="time">05:00</span></button>
  </div>

  <!-- settings drawer -->
  <aside id="settingsPanel" aria-hidden="true">
    <h2>Feedback Options</h2>
    <label>Sound
      <span class="switch"><input type="checkbox" id="soundToggle" checked /><span class="slider"></span></span>
    </label>
    <label>Vibration
      <span class="switch"><input type="checkbox" id="vibeToggle" checked /><span class="slider"></span></span>
    </label>
  </aside>

  <script>
    /* ── helpers ─────────────────────────────────────────────── */
    const fmt = s => {
      const m = String(Math.floor(s / 60)).padStart(2, "0");
      const c = String(s % 60).padStart(2, "0");
      return m + ":" + c;
    };

    /* ── element map ─────────────────────────────────────────── */
    const el = {
      p1:          document.getElementById("p1"),
      p2:          document.getElementById("p2"),
      t1:          document.getElementById("t1"),
      t2:          document.getElementById("t2"),
      pauseBtn:    document.getElementById("pauseBtn"),
      resetBtn:    document.getElementById("resetBtn"),
      preset:      document.getElementById("preset"),
      settingsBtn: document.getElementById("settingsBtn"),
      panel:       document.getElementById("settingsPanel"),
      soundToggle: document.getElementById("soundToggle"),
      vibeToggle:  document.getElementById("vibeToggle")
    };

    /* ── state ───────────────────────────────────────────────── */
    let baseTime = 300;
    let remaining = [baseTime, baseTime];
    let active = -1;      // 0 or 1
    let paused = true;
    let lastTS = 0;
    let rafId  = null;
    let audioCtx = null;

    /* ── sound/vibration ─────────────────────────────────────── */
    const beep = d => {
      if (!el.soundToggle.checked) return;
      audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
      const o = audioCtx.createOscillator();
      o.frequency.value = 1000;
      o.connect(audioCtx.destination);
      o.start();
      setTimeout(()=>o.stop(), d);
    };
    const vibrate = p => el.vibeToggle.checked && navigator.vibrate && navigator.vibrate(p);

    /* ── persistence ─────────────────────────────────────────── */
    const save = () => localStorage.setItem("chessClock2",
      JSON.stringify({baseTime, remaining, active, paused, ts: Date.now()}));
    const load = () => {
      const raw = localStorage.getItem("chessClock2");
      if (!raw) return;
      try {
        const s = JSON.parse(raw);
        if (![300,600,900].includes(s.baseTime)) return;
        baseTime = s.baseTime; el.preset.value = baseTime;
        remaining = s.remaining;
        active = s.active;
        paused = s.paused;
        if (!paused && active>-1) {
          const diff = Math.floor((Date.now()-s.ts)/1000);
          remaining[active] = Math.max(0, remaining[active]-diff);
        }
        draw();
        if (!paused && active>-1) loopStart();
      } catch{}
    };

    /* ── drawing ─────────────────────────────────────────────── */
    function draw() {
      el.t1.textContent = fmt(remaining[0]);
      el.t2.textContent = fmt(remaining[1]);
      [el.p1,el.p2].forEach((btn,i)=>{
        btn.classList.remove("active","paused");
        if (paused) btn.classList.add("paused");
        else if (i===active) btn.classList.add("active");
      });
      el.pauseBtn.textContent = paused ? "Resume" : "Pause";
    }

    /* ── main loop ───────────────────────────────────────────── */
    function tick() {
      if (paused || active===-1) return;
      const now = Date.now();
      const dt  = now - lastTS;
      if (dt>=1000) {
        const s = Math.floor(dt/1000);
        remaining[active] = Math.max(0, remaining[active]-s);
        lastTS += s*1000;
        if (remaining[active]===0) { gameOver(); return; }
        draw();
      }
      rafId = requestAnimationFrame(tick);
    }
    const loopStart = () => { cancelAnimationFrame(rafId); lastTS = Date.now(); rafId = requestAnimationFrame(tick); };

    /* ── actions ─────────────────────────────────────────────── */
    function switchTo(idx) {
      if (remaining[idx]===0) return;
      if (paused) {
        paused=false; active=idx; beep(50); vibrate(30); loopStart();
      } else if (active!==idx) {
        active=idx; beep(50); vibrate(30);
      }
      draw(); save();
    }
    function pause() { paused=true; cancelAnimationFrame(rafId); draw(); save(); }
    function resume(){ if(active===-1) return; paused=false; loopStart(); draw(); save(); }
    function reset() {
      cancelAnimationFrame(rafId);
      remaining=[baseTime,baseTime]; paused=true; active=-1;
      draw(); save();
    }
    function gameOver() {
      cancelAnimationFrame(rafId);
      paused=true; beep(400); vibrate([100,80,100]); draw(); save();
    }

    /* ── events ──────────────────────────────────────────────── */
    el.p1.addEventListener("click",()=>switchTo(0));
    el.p2.addEventListener("click",()=>switchTo(1));
    el.pauseBtn.addEventListener("click", ()=> paused ? resume() : pause());
    el.resetBtn.addEventListener("click", reset);
    el.preset.addEventListener("change", e => { baseTime=Number(e.target.value); reset();});
    el.settingsBtn.addEventListener("click",()=> el.panel.classList.toggle("open"));
    document.addEventListener("visibilitychange", ()=> document.visibilityState==="hidden" && save());
    window.addEventListener("beforeunload", save);

    /* ── init ────────────────────────────────────────────────── */
    draw(); load();
  </script>
</body>
</html>
