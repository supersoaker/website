<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Chess Clock</title>
  <meta name="viewport"
        content="width=device-width,initial-scale=1.0,maximum-scale=1,user-scalable=no" />

  <style>
    :root {
      --beige: #fee7b6;
      --green: #2ecc71;
      --gray:  #505050;
      --gray-light: #6d6d6d;
      --black: #000;
      --white: #fff;
      --shadow: 0 4px 10px rgba(0,0,0,.25);
    }

    /* -------- RESET / BASICS -------- */
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; width: 100%; background: var(--beige); font-family: "Segoe UI", sans-serif; overscroll-behavior: none; }

    /* -------- LAYOUT -------- */
    #wrapper { height: 100%; display: flex; flex-direction: column; gap: 0.75rem; padding: 0.75rem; }

    /* -------- TIMER BUTTONS -------- */
    .timer {
      flex: 1;
      border: none;
      border-radius: 14px;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s, color 0.2s;
      font-variant-numeric: tabular-nums;
      color: var(--white);
      background: var(--gray);
    }
    .timer.active { background: var(--green); }
    .timer.paused { background: var(--gray-light); }

    .time { font-size: 18vw; line-height: 1; }
    @media (min-aspect-ratio: 3/2) { .time { font-size: 18vh; } }

    /* -------- CENTRAL CONTROLS -------- */
    #controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
    }
    button.ctrl {
      padding: 0.6rem 1rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      color: var(--white);
      background: var(--black);
      box-shadow: var(--shadow);
    }
    select#preset {
      padding: 0.6rem 0.8rem;
      border-radius: 8px;
      border: none;
      font-size: 1rem;
      background: var(--gray);
      color: var(--white);
      cursor: pointer;
      box-shadow: var(--shadow);
    }
  </style>
</head>

<body>
  <div id="wrapper">
    <button id="p1" class="timer"><span id="t1" class="time">05:00</span></button>

    <div id="controls">
      <button id="pauseBtn" class="ctrl">Pause</button>
      <button id="resetBtn" class="ctrl">Reset</button>
      <select id="preset" aria-label="Preset time">
        <option value="300">5 min</option>
        <option value="600">10 min</option>
        <option value="900">15 min</option>
      </select>
    </div>

    <button id="p2" class="timer"><span id="t2" class="time">05:00</span></button>
  </div>

  <script>
    /* ---------- HELPERS ---------- */
    const fmt = s => `${String(Math.floor(s/60)).padStart(2,"0")}:${String(s%60).padStart(2,"0")}`;

    /* ---------- ELEMENTS ---------- */
    const el = {
      p1:       document.getElementById("p1"),
      p2:       document.getElementById("p2"),
      t1:       document.getElementById("t1"),
      t2:       document.getElementById("t2"),
      pauseBtn: document.getElementById("pauseBtn"),
      resetBtn: document.getElementById("resetBtn"),
      preset:   document.getElementById("preset"),
    };

    /* ---------- STATE ---------- */
    let baseTime = 300;            // seconds
    let remaining = [baseTime, baseTime];
    let active = -1;               // 0 or 1, -1 = not started
    let paused = true;
    let lastTS = 0;
    let rafId;
    let audioCtx;

    /* ---------- SOUND / VIBRATION ---------- */
    const beep = dur => {
      audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
      const osc = audioCtx.createOscillator();
      osc.frequency.value = 1000;
      osc.connect(audioCtx.destination);
      osc.start(); setTimeout(()=>osc.stop(), dur);
    };
    const vibrate = pat => navigator.vibrate && navigator.vibrate(pat);

    /* ---------- PERSISTENCE ---------- */
    const save = () =>
      localStorage.setItem("chessClock3", JSON.stringify({baseTime, remaining, active, paused, ts: Date.now()}));

    const load = () => {
      const raw = localStorage.getItem("chessClock3");
      if (!raw) return;
      try {
        const s = JSON.parse(raw);
        if (![300,600,900].includes(s.baseTime)) return;
        baseTime = s.baseTime; el.preset.value = baseTime;
        remaining = s.remaining;
        active = s.active;
        paused = s.paused;
        if (!paused && active>-1) {
          const diff = Math.floor((Date.now()-s.ts)/1000);
          remaining[active] = Math.max(0, remaining[active]-diff);
        }
        draw();
        if (!paused && active>-1) loopStart();
      } catch {}
    };

    /* ---------- UI REFRESH ---------- */
    const draw = () => {
      el.t1.textContent = fmt(remaining[0]);
      el.t2.textContent = fmt(remaining[1]);

      [el.p1,el.p2].forEach((btn,i)=>{
        btn.classList.remove("active","paused");
        if (paused) btn.classList.add("paused");
        else if (i===active) btn.classList.add("active");
      });
      el.pauseBtn.textContent = paused ? "Resume" : "Pause";
    };

    /* ---------- TIMER LOOP ---------- */
    const tick = () => {
      if (paused || active===-1) return;
      const now = Date.now();
      const dt = now - lastTS;
      if (dt >= 1000) {
        const secs = Math.floor(dt/1000);
        remaining[active] = Math.max(0, remaining[active]-secs);
        lastTS += secs*1000;
        if (remaining[active] === 0) { gameOver(); return; }
        draw();
      }
      rafId = requestAnimationFrame(tick);
    };
    const loopStart = () => { cancelAnimationFrame(rafId); lastTS = Date.now(); rafId = requestAnimationFrame(tick); };

    /* ---------- GAME LOGIC ---------- */
    function press(idx) {
      /* idx is the side pressed */

      if (paused) {
        if (active === -1) {          // game just starting
          active = 1 - idx;           // your press starts opponent’s clock
          paused = false; beep(50); vibrate(30); loopStart();
        } else if (idx === active) {  // resume same side (after manual pause)
          paused = false; beep(50); vibrate(30); loopStart();
        }
        /* ignore presses on inactive side when paused */
      } else {
        if (idx === active) {         // normal switch
          active = 1 - active; beep(50); vibrate(30);
        }
        /* ignore presses on inactive side while running */
      }
      draw(); save();
    }

    const pause = () => { paused = true; cancelAnimationFrame(rafId); draw(); save(); };
    const resume = () => { if(active===-1) return; paused=false; loopStart(); draw(); save(); };
    const reset = () => {
      cancelAnimationFrame(rafId);
      remaining = [baseTime, baseTime];
      active = -1; paused = true;
      draw(); save();
    };
    const gameOver = () => {
      cancelAnimationFrame(rafId);
      paused = true; beep(400); vibrate([100,80,100]); draw(); save();
    };

    /* ---------- EVENTS ---------- */
    el.p1.addEventListener("click",()=>press(0));
    el.p2.addEventListener("click",()=>press(1));
    el.pauseBtn.addEventListener("click", ()=> paused ? resume() : pause());
    el.resetBtn.addEventListener("click", reset);
    el.preset.addEventListener("change", e => { baseTime = Number(e.target.value); reset(); });
    document.addEventListener("visibilitychange", ()=> document.visibilityState==="hidden" && save());
    window.addEventListener("beforeunload", save);

    /* ---------- INIT ---------- */
    draw(); load();
  </script>
</body>
</html>
